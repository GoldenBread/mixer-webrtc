<html>
    <head>
        <title>Audio source</title>
        <script src="../RTCMultiConnection.js"></script>
        <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
    </head>
    <button id="btn-open-room">Open Room</button>
    <button id="btn-join-room">Join Room</button><hr>
    <body>
    </body>
</html>

<script>
var connection = new RTCMultiConnection();

var userDestination = null;

// this line is VERY_important
connection.socketURL = 'https://192.168.1.14:9001/';

// all below lines are optional; however recommended.

connection.userid = 'source-' + connection.userid;

connection.session = {
    oneway: true,
    video: false
};

connection.dontCaptureUserMedia = true;
connection.dontGetRemoteStream = true;

var BandwidthHandler = connection.BandwidthHandler;
connection.bandwidth = {
	audio: 510,
	video: 256,
	screen: 300
};
connection.processSdp = function(sdp) {
    sdp = BandwidthHandler.setApplicationSpecificBandwidth(sdp, connection.bandwidth, !!connection.session.screen);
    sdp = BandwidthHandler.setVideoBitrates(sdp, {
        min: connection.bandwidth.video,
        max: connection.bandwidth.video
    });

    sdp = BandwidthHandler.setOpusAttributes(sdp);

    sdp = BandwidthHandler.setOpusAttributes(sdp, {
        'stereo': 1,
        //'sprop-stereo': 1,
        'maxaveragebitrate': connection.bandwidth.audio * 1000 * 8,
        'maxplaybackrate': connection.bandwidth.audio * 1000 * 8,
        //'cbr': 1,
        //'useinbandfec': 1,
        // 'usedtx': 1,
        'maxptime': 3
    });

    return sdp;
};

//UserMedia WebRTC natif
connection.mediaConstraints = {
    audio: {
        sampleRate: 48000,
        sampleSize: 24,
        channelCount: 2,
        volume: 1.0,
        autoGainControl: false,
        echoCancellation: false,
        noiseSuppression: false,
    },
    video: false
};

connection.iceServers = [];

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: false,
    OfferToReceiveVideo: false
};


connection.onstream = function(event) {
    console.log(event);
    console.log("new STREAM");
    console.log("EVENT " + event.streamid);
    if (event.userid != connection.userid) {
        connection.removeStream(event.streamid);
    } else {
    }
    document.body.appendChild( event.mediaElement );
    //} else {

    //}
};

connection.onSettingLocalDescription = function(event) {
    console.log("onSettingLocalDescription");
    console.log(event);
    if (!userDestination && event.userid.substring(0, 11) == "destination") {
        console.log("Destination user found adding stream: " + event.userid);
        console.log(connection);
        connection.peers[event.userid].addStream({
            audio: true,
            oneway: true
        });

        userDestination = event.userid;
    }
};


connection.beforeAddingStream = function(stream, peer) {
    console.log("BeforeAddingStream");
    console.log(peer.userId);
    
    return stream; // otherwise allow RTCMultiConnection to share this stream with remote users
};

connection.onNewParticipant = function(participantId, userPreferences) {//override de la fonction de base new participant qui semble ajouter le stream de tous les users qui join
    /*if (participantId.substring(0, 6) == "source") {
        //connection.deletePeer(participantId);
    }*/
};

var predefinedRoomId = '437829';

document.getElementById('btn-open-room').onclick = function() {
    this.disabled = true;
    connection.open( predefinedRoomId );
};

document.getElementById('btn-join-room').onclick = function() {
    this.disabled = true;
    connection.join( predefinedRoomId);
};
</script>