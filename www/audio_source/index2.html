<html>
    <head>
        <title>Audio source</title>
        <script src="../RTCMultiConnection.js"></script>
        <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
    </head>
    <button id="btn-open-room">Open Room</button>
    <button id="btn-join-room">Join Room</button><hr>
    <body>
    </body>
</html>

<script>
var connection = new RTCMultiConnection();

var userDestination = null;

// this line is VERY_important
connection.socketURL = 'https://192.168.1.14:9001/';

// all below lines are optional; however recommended.

connection.userid = 'source-' + connection.userid;

connection.session = {
    oneway: true,
};

connection.dontCaptureUserMedia = true;
connection.dontGetRemoteStream = true;

//UserMedia WebRTC natif
connection.mediaConstraints = {
    audio: {
        sampleRate: 48000,
        sampleSize: 24,
        channelCount: 2,
        volume: 1.0,
        autoGainControl: false,
        echoCancellation: false,
        noiseSuppression: false,
    },
    video: false
};

connection.iceServers = [];

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: false,
    OfferToReceiveVideo: false
};


connection.onstream = function(event) {
    console.log(event);
    console.log("new STREAM");
    console.log("EVENT " + event.streamid);
    if (event.userid != connection.userid) {
        connection.removeStream(event.streamid);
    }
    document.body.appendChild( event.mediaElement );
};

connection.onSettingLocalDescription = function(event) {
    console.log("onSettingLocalDescription");
    console.log(event);
    if (!userDestination && event.userid.substring(0, 11) == "destination") {
        console.log("Destination user found adding stream: " + event.userid);
        console.log(connection);
        connection.peers[event.userid].addStream({
            audio: true,
            oneway: true
        });

        userDestination = event.userid;
    }
};

connection.onNewParticipant = function(participantId, userPreferences) {//override de la fonction de base new participant qui semble ajouter le stream de tous les users qui join
};

var predefinedRoomId = '437829';

document.getElementById('btn-open-room').onclick = function() {
    this.disabled = true;
    connection.open( predefinedRoomId );
};

document.getElementById('btn-join-room').onclick = function() {
    this.disabled = true;
    connection.join( predefinedRoomId);
};
</script>