<html>
    <head>
        <title>Audio destination</title>
        <script src="../RTCMultiConnection.js"></script>
        <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
    </head>
    <button id="btn-open-room">Open Room</button>
    <button id="btn-join-room">Join Room</button><hr>
    <button id="checkMediaStream">Check media stream</button><hr>
    <button id="muttee">Mute</button><hr>
    <body>
    </body>
</html>

<script>
var connection = new RTCMultiConnection();

// this line is VERY_important
connection.socketURL = 'https://192.168.1.14:9001/';

// all below lines are optional; however recommended.

connection.userid = 'destination-' + connection.userid;

connection.session = {
    audio: true,
    video: false
};

connection.dontCaptureUserMedia = true;

var localStream = null;

var BandwidthHandler = connection.BandwidthHandler;
connection.bandwidth = {
	audio: 510,
	video: 256,
	screen: 300
};
connection.processSdp = function(sdp) {
    sdp = BandwidthHandler.setApplicationSpecificBandwidth(sdp, connection.bandwidth, !!connection.session.screen);
    sdp = BandwidthHandler.setVideoBitrates(sdp, {
        min: connection.bandwidth.video,
        max: connection.bandwidth.video
    });

    sdp = BandwidthHandler.setOpusAttributes(sdp);

    sdp = BandwidthHandler.setOpusAttributes(sdp, {
        'stereo': 1,
        //'sprop-stereo': 1,
        'maxaveragebitrate': connection.bandwidth.audio * 1000 * 8,
        'maxplaybackrate': connection.bandwidth.audio * 1000 * 8,
        //'cbr': 1,
        //'useinbandfec': 1,
        // 'usedtx': 1,
        'maxptime': 3
    });

    return sdp;
};

connection.mediaConstraints = {
    audio: true,
    video: false
};


connection.iceServers = [];

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: false
};

connection.onstream = function(event) {

    console.log("new STREAM");
    console.log(event);
    if (event.userid != connection.userid) {
        document.body.appendChild( event.mediaElement );
    } else {
        console.log("DIsABLING...");
        //event.stream.stop();
    }
};


var predefinedRoomId = '437829';

document.getElementById('btn-open-room').onclick = function() {
    this.disabled = true;
    connection.open( predefinedRoomId );
};

document.getElementById('btn-join-room').onclick = function() {
    this.disabled = true;
    connection.join( predefinedRoomId );
};

document.getElementById('checkMediaStream').onclick = function() {
    console.log("checkMediaStream");
    
    connection.streamEvents.selectAll({
    local: true
    }).forEach(function(localStreamEvent) {
        console.log(localStreamEvent.stream)
    });
};

document.getElementById('muttee').onclick = function() {
    connection.streamEvents.selectAll({
        local: true
    }).forEach(function(localStreamEvent) {
        console.log(localStreamEvent.stream)
        localStreamEvent.stream.stop();
    });
};

</script>